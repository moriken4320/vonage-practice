const webrtc = new Vue({
    el: "#moderator-wrapper",
    data: {
        userName: '',
        vonageOnlySignalHelper: null,
        vonageHelper: null,
        audioLevel: 0,
        signalText: {
            type: '',
            data: '',
        },
        authRequests: [],
        signalTarget: null,
        isBroadcast: false,
        isRecorded: false,
    },
    computed: {
        connectButtonText() {
            return this.vonageHelper.isConnected ? 'dis connect' : 'connect'
        },
        publishButtonText() {
            return this.vonageHelper.isPublished ? 'stop publish' : 'start publish'
        },
        audioButtonText() {
            return this.vonageHelper.enableAudio ? 'stop audio' : 'start audio'
        },
        videoButtonText() {
            return this.vonageHelper.enableVideo ? 'stop video' : 'start video'
        },
        broadcastButtonText() {
            return this.isBroadcast ? 'stop broadcast' : 'start broadcast'
        },
        recordingButtonText() {
            return this.isRecorded ? 'stop recording' : 'start recording'
        },
    },
    watch: {
        vonageHelper: {
            handler: function(newValue) {
                //console.log(newValue);
            },
            deep: true
        },
    },
    created() {
        this.isBroadcast = '<%= @campaign.status %>' === '1';
        this.isRecorded = '<%= @campaign.is_recorded %>' === 'true';

        this.vonageOnlySignalHelper = new VonageHelper(
            '<%= @opentokInfo[:api_key] %>',
            '<%= @campaign.sub_session_id %>',
            '<%= @opentokInfo[:token] %>',
            true
        );
        this.vonageOnlySignalHelper.init();
        this.vonageOnlySignalHelper.registerSignalEvent('authRequest', this.setAuthRequests);

        this.vonageHelper = new VonageHelper(
            '<%= @opentokInfo[:api_key] %>',
            '<%= @campaign.session_id %>',
            ''
        );
        this.vonageHelper.init();
    },
    mounted() {
        // オーディオレベルを取得
        setInterval(() => {
            $("#audio-level > div").width(`${this.vonageHelper.audioLevel * 100}%`);
        }, 100);

        // デバイスソース変更時イベント
        navigator.mediaDevices.ondevicechange = async (event) => {
            await this.vonageHelper.deviceUpdated();
        }
    },
    methods: {
        setAuthRequests(event) {
            this.authRequests = this.authRequests.filter(function(request) {
                return request.from !== event.from;
            });
            this.authRequests.push(event);
        },
        join() {
            if (this.userName === '') return;
            const url = `/campaigns/${'<%= @campaign.id %>'}/generate_moderator_token`;
            Utility.getToken(url, this.userName, (token) => {
                this.vonageHelper.token = token;
                this.vonageOnlySignalHelper.sessionConnect();
                this.vonageHelper.sessionConnect();
            });
        },
        connect() {
            if(this.vonageHelper.isConnected) {
                this.vonageOnlySignalHelper.sessionDisconnect();
                this.vonageHelper.sessionDisconnect();
            } else {
                this.vonageOnlySignalHelper.sessionConnect();
                this.vonageHelper.sessionConnect();
            }
        },
        publish() {
            this.vonageHelper.isPublished ? this.vonageHelper.unPublish() : this.vonageHelper.publish()
        },
        sendSignal() {
            if (this.signalText.type === '' || this.signalText.data === '') return;

            this.vonageHelper.sendSignal(this.signalText.type, this.signalText.data, this.signalTarget);
            this.signalText.type = '';
            this.signalText.data = '';
        },
        allowRequest(requestInfo) {
            const url = `/campaigns/${'<%= @campaign.id %>'}/generate_publisher_token`;
            Utility.getToken(url, requestInfo.data, (token) => {
                this.vonageOnlySignalHelper.sendSignal('receiveToken', token, requestInfo.from);
                this.removeRequest(requestInfo);
            });
        },
        removeRequest(requestInfo) {
            this.authRequests = this.authRequests.filter(function(request) {
                return request !== requestInfo;
            });
        },
        broadcast() {
            const url = this.isBroadcast ? `/campaigns/${'<%= @campaign.id %>'}/stop_broadcast` : `/campaigns/${'<%= @campaign.id %>'}/start_broadcast`
            window.axios.get(url).then((response) => {
                this.isBroadcast = response.data;
                const isBroadcastText = this.isBroadcast ? 'true' : 'false';
                this.vonageOnlySignalHelper.sendSignal('broadcast', isBroadcastText);
                this.vonageHelper.sendSignal('broadcast', isBroadcastText);
            });
        },
        recording() {
            const url = this.isRecorded ? `/campaigns/${'<%= @campaign.id %>'}/stop_recording` : `/campaigns/${'<%= @campaign.id %>'}/start_recording`
            window.axios.get(url).then((response) => {
                this.isRecorded = response.data;
            });
        },
    },
});